---
title: 领域模型
date: 2022-03-22 15:29:08
categories: 
- Java后端
tags:
- 设计思想
---

# 领域模型

### 领域模型设计系统的过程步骤

1. 事件风暴 + 领域分析：用例分析、场景分析、用户旅程
2. 操作、命令、事件 --> 实体 与 聚合
3. 领域模型 --> 代码模型
4. 代码落地



### 域的分类


 - 通用域：权限、认证，通常可以买到
 - 核心域：公司核心竞争力 - 会随着公司战略、业务模式等不同，核心域会不同
 - 支撑域：根据公司业务个性化定制



### 上下文界限

上下文界限例子，四个阶段中保单的四个领域实体，

1. 客户投保时，业务人员记录投保信息，系统对应有投保单实体对象
2. 缴费完成后，业务人员将投保单转为**保单**，系统对应有保单实体对象，保单实体与投保单实体关联
3. 如客户需要修改保单信息，保单变为批单，系统对应有批单实体对象，批单实体与保单实体关联
4. 如果客户发生理赔，生成赔案，系统对应有报案实体对象，报案实体对象与保单或者批单实体关联

# 实体与值对象

### 实体

- 业务形态
  - 根据操作、命令、事件找到业务实体
  - 根据业务规则进行聚类
- 代码形态
  - 完成自身的业务逻辑（通常是充血模型）
  - *跨多个实体的领域逻辑，在Service中完成
- 运行形态
  - 运行时，通过ID作为唯一标识
  - 通过ID判断相等
- 数据库形态
  - 优先产生领域模型，再考虑计数据库的持久化
  - 多数情况下是与实体一对一的
  - 但是某些情况下也可以是一对多，多对一
  - 甚至是内存暂存状态，也就是一对0。

### 值对象

- 业务形态
  - 一种属性集合
  - 最典型的值对象就是数据字典
- 代码形态
  - 基本不包含业务逻辑
  - 只有数据初始化操作、有限的不涉及修改数据的业务
- 运行形态
  - 初始化构造
  - 在实体中替换值对象（创建后不能修改，只能用另外一个值对象替换）
  - 通过属性值判断相等
- 数据库形态
  - 可以单独成表
  - 也可以嵌入在实体的表中

### 两者关系

值对象是对实体的描述。在不同的领域甚至是子域里面，实体和值对象是可以互换的，如

- 开立医嘱的业务中，医生作为被医嘱实体引用的描述，是一个值对象。
- 在用户信息修改的业务中，医生就是存在唯一ID的实体了



# 聚合和聚合根

### 概念

- 聚合根是一个实体，相当于单个聚合的管理者
- 聚合是指负责**单一业务职责**、**高聚合**的一系列实体和值对象
- 聚合是通过充血模型实现的
- 聚合存在上下文边界，边界之间是松耦合的

### 举例

一个聚合诞生的完整过程：

1. 采用事件风暴，根据业务行为，梳理出在投保过程中发生这些行为的所有的实体和值对象，比如投保单、标的、客户、被保人等等。
2. 从众多实体中选出适合作为对象管理者的聚合根。判断一个实体是否是聚合根，可以结合场景分析：
   - 是否有独立的什么周期（实体 / 值对象）
   - 是否有全局唯一ID（实体 / 值对象）
   - 是否可以创建或修改其他对象（实体 / 值对象）
   - 是否有专门的模块来管理这个实体（实体 / 聚合根）
   - 本例中两个聚合根分别是 **投保单** 和 **客户**
3. 根据业务单一职责和高内聚原则，找出与聚合根关联的所有紧密依赖的实体和值对象。构建出一个包含聚合根（唯一）、多个实体和值对象的对象集合，这个集合就是聚合。
4. 在聚合内根据聚合根、实体和值对象的依赖关系，理出对象的引用和依赖模型。在本例中，投保人和被保人的数据，是通过关联客户ID从客户聚合中获取的，在投保聚合里它们是投保单的值对象，这些值对象的数据是客户的冗余数据，即使未来客户聚合的数据发生了变更，也不会影响投保单的值对象数据。例子中，投保聚合里投保单聚合根引用了报价单实体，报价单实体则引用了报价规则实体。
5. 多个聚合根据业务语义和上下文一起划分到同一个限界上下文内。

### 设计原则

- 聚合在一致性边界内建模真正的不变条件
- 设计小聚合（聚合不宜包含太多的实体）
- 通过ID引用其他聚合
- 聚合内的数据，在边界之外使用最终一致性
- 通过应用层实现跨聚合的服务调用（领域层内，不应该进行跨聚合之间的调用）

# 领域事件

CDSS系统中暂时没有业务步骤，也不需要领域事件

1. 事件构建和发布
2. 事件数据持久化
3. 事件总线
4. 消息中间件
5. 事件接收和处理



事件基类：

- ID: String
- createTime: Date
- eventType: String
- eventSource: String
- BusinessData: T



# 领域模型架构

### 传统三层架构

- 业务接口层
  - Module - API
- 业务逻辑层
  - VO
  - Service
- 数据访问层
  - PO
  - MapperXML
  - Dao

### ★DDD分层模型

- 用户接口层
  - API
  - DTO
- 应用层（应对快速的业务变化）
  - Application Service
- 领域层（核心业务能力）
  - Aggregate
    - Domain Service
    - Entity
    - Value Object
  - MapperXML
  - Repository
- 基础层
  - Repository AOP
  - 网关
  - 第三方库
  - 文件
  - 其他

![image-20220509175728519](https://feng.mynatapp.cc/blog/image-20220509175728519.png)

### ★整洁架构

![image-20220509175757890](https://feng.mynatapp.cc/blog/image-20220509175757890.png)
